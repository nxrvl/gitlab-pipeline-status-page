<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Settings - GitLab Pipeline Status</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .project-list {
            max-height: 600px;
            overflow-y: auto;
        }
        .search-box {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: white;
            padding: 10px 0;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">GitLab Pipeline Status</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/">Status</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/settings">Settings</a>
                </li>
            </ul>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i> {{ .Username }}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" href="/logout">Logout</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Settings</h1>
        <div>
            <a href="/" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Back to Status
            </a>
        </div>
    </div>
    
    <!-- GitLab URL setting removed as requested -->

    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Project Selection</h5>
                <div class="btn-group" role="group">
                    <a href="/settings" class="btn btn-outline-secondary btn-sm {{if .TreeView}}active{{end}}">
                        <i class="bi bi-diagram-3"></i> Group Tree
                    </a>
                    <a href="/settings/projects" class="btn btn-outline-secondary btn-sm {{if not .TreeView}}active{{end}}">
                        <i class="bi bi-list"></i> All Projects
                    </a>
                </div>
                <div class="ms-2">
                    <button id="cacheButton" class="btn btn-outline-primary btn-sm" onclick="preloadGitLabData()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Data
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <p>Select the GitLab projects you want to monitor on the status page.</p>
            
            {{if .Caching}}
            <div class="alert alert-info">
                <h5 class="alert-heading"><i class="bi bi-info-circle"></i> Refreshing GitLab Data</h5>
                <p>{{.ApiError}}</p>
                <div class="progress mt-2 mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
                <p>Once complete, you'll be able to view and select projects.</p>
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="checkCacheStatusManual()">
                        <i class="bi bi-arrow-clockwise"></i> Check Status
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="window.location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Page
                    </button>
                </div>
            </div>
            {{else if .ApiError}}
            <div class="alert alert-danger">
                <h5 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> GitLab API Error</h5>
                <p>{{.ApiError}}</p>
                <hr>
                <p class="mb-0">Tips to resolve this issue:</p>
                <ul>
                    <li>Verify your GitLab API token has sufficient permissions</li>
                    <li>Check if your GitLab instance "{{.GitLabURL}}" is accessible</li>
                    <li><strong>Try increasing the API timeout</strong> in your environment settings (GITLAB_API_TIMEOUT)</li>
                    <li>If you're using a large GitLab instance, the request might still be processing in the background</li>
                </ul>
                <div class="mt-3 d-flex gap-2">
                    <a href="/settings" class="btn btn-primary">Retry</a>
                    <button type="button" class="btn btn-outline-secondary" onclick="window.location.reload()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Page
                    </button>
                </div>
            </div>
            {{else}}
            <form method="POST" action="/settings" id="projectsForm">
                <input type="hidden" name="form_type" value="projects">
                <div class="search-box mb-3">
                    <input type="text" id="projectSearch" class="form-control" placeholder="Search projects...">
                </div>
                
                {{if .TreeView}}
                <!-- Group Tree View -->
                <div class="project-list mb-3">
                    {{if .GroupTree}}
                        <div class="list-group group-tree">
                            {{range .GroupTree}}
                            <div class="group-item">
                                <!-- Group header -->
                                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" style="padding-left: {{mul .Level 20}}px;">
                                    <div>
                                        {{if .HasChildren}}
                                            {{if .Expanded}}
                                                <a href="/settings?action=collapse&groupID={{.ID}}" class="text-decoration-none me-2">
                                                    <i class="bi bi-dash-square"></i>
                                                </a>
                                            {{else}}
                                                <a href="/settings?action=expand&groupID={{.ID}}" class="text-decoration-none me-2">
                                                    <i class="bi bi-plus-square"></i>
                                                </a>
                                            {{end}}
                                        {{else}}
                                            <i class="bi bi-folder me-2 text-muted"></i>
                                        {{end}}
                                        <strong>{{.Name}}</strong>
                                        <span class="text-muted ms-2">({{.FullPath}})</span>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">
                                        {{len .Projects}} project{{if ne (len .Projects) 1}}s{{end}}
                                    </span>
                                </div>
                                
                                {{if .Expanded}}
                                    <!-- Projects in this group -->
                                    {{range .Projects}}
                                    <label class="list-group-item" style="padding-left: {{add (mul .Level 20) 20}}px;">
                                        <input class="form-check-input me-2" type="checkbox" name="projects" value="{{.ID}}" {{if .Selected}}checked{{end}}>
                                        <strong>{{.Name}}</strong>
                                        <div class="text-muted small">{{.PathWithNamespace}}</div>
                                    </label>
                                    {{end}}
                                    
                                    <!-- Subgroups (recursive template would be better in a real app) -->
                                    {{range .Subgroups}}
                                    <div class="group-item">
                                        <!-- Subgroup header -->
                                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" style="padding-left: {{mul .Level 20}}px;">
                                            <div>
                                                {{if .HasChildren}}
                                                    {{if .Expanded}}
                                                        <a href="/settings?action=collapse&groupID={{.ID}}" class="text-decoration-none me-2">
                                                            <i class="bi bi-dash-square"></i>
                                                        </a>
                                                    {{else}}
                                                        <a href="/settings?action=expand&groupID={{.ID}}" class="text-decoration-none me-2">
                                                            <i class="bi bi-plus-square"></i>
                                                        </a>
                                                    {{end}}
                                                {{else}}
                                                    <i class="bi bi-folder me-2 text-muted"></i>
                                                {{end}}
                                                <strong>{{.Name}}</strong>
                                                <span class="text-muted ms-2">({{.FullPath}})</span>
                                            </div>
                                            <span class="badge bg-primary rounded-pill">
                                                {{len .Projects}} project{{if ne (len .Projects) 1}}s{{end}}
                                            </span>
                                        </div>
                                        
                                        {{if .Expanded}}
                                            <!-- Projects in this subgroup -->
                                            {{range .Projects}}
                                            <label class="list-group-item" style="padding-left: {{add (mul .Level 20) 20}}px;">
                                                <input class="form-check-input me-2" type="checkbox" name="projects" value="{{.ID}}" {{if .Selected}}checked{{end}}>
                                                <strong>{{.Name}}</strong>
                                                <div class="text-muted small">{{.PathWithNamespace}}</div>
                                            </label>
                                            {{end}}
                                        {{end}}
                                    </div>
                                    {{end}}
                                {{end}}
                            </div>
                            {{end}}
                        </div>
                    {{else}}
                        <div class="text-center py-4">
                            <div class="alert alert-info">
                                <p><strong>No data available:</strong> No group data is available in the database.</p>
                                <p>Please click the "Refresh Data" button to load the GitLab structure.</p>
                            </div>
                        </div>
                    {{end}}
                </div>
                {{else}}
                <!-- Flat Project List View -->
                <div class="project-list">
                    <div class="list-group">
                        {{if .Projects}}
                            {{range .Projects}}
                            <label class="list-group-item">
                                <input class="form-check-input me-2" type="checkbox" name="projects" value="{{.ID}}" {{if .Selected}}checked{{end}}>
                                <strong>{{.Name}}</strong>
                                <div class="text-muted small">{{.PathWithNamespace}}</div>
                            </label>
                            {{end}}
                        {{else}}
                            <div class="text-center py-4">
                                <div class="alert alert-info">
                                    <p><strong>No data available:</strong> No project data is available in the database.</p>
                                    <p>Please click the "Refresh Data" button to load the GitLab projects.</p>
                                </div>
                            </div>
                        {{end}}
                    </div>
                </div>
                {{end}}
                
                <div class="mt-4 d-flex justify-content-between">
                    <div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="selectAll">Select All</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="deselectAll">Deselect All</button>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </div>
            </form>
            {{end}}
        </div>
    </div>
</div>

<script>
    // Helper functions for calculations in template
    function mul(a, b) {
        return a * b;
    }
    
    function add(a, b) {
        return a + b;
    }
</script>

<script>
    // Function to preload GitLab data (projects and groups)
    function preloadGitLabData() {
        const cacheButton = document.getElementById('cacheButton');
        const originalText = cacheButton.innerHTML;
        
        cacheButton.disabled = true;
        cacheButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';
        
        // Show alert to user
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-info mt-3';
        alertDiv.innerHTML = `
            <h5><i class="bi bi-info-circle"></i> Refreshing GitLab Structure</h5>
            <p>Refreshing all projects and groups from GitLab. This may take several minutes.</p>
            <p>You will be notified when the process completes.</p>
            <div class="progress mt-2">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
        `;
        
        document.querySelector('.card-body').prepend(alertDiv);
        
        // Make the API call to start caching
        fetch('/settings/cache', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            // Start checking status periodically
            checkCacheStatus(cacheButton, originalText, alertDiv);
        })
        .catch(error => {
            alertDiv.className = 'alert alert-danger mt-3';
            alertDiv.innerHTML = `
                <h5><i class="bi bi-exclamation-triangle"></i> Error</h5>
                <p>Failed to start preloading: ${error}</p>
            `;
            cacheButton.disabled = false;
            cacheButton.innerHTML = originalText;
        });
    }
    
    // Function to periodically check cache status
    function checkCacheStatus(button, originalText, alertDiv) {
        const checkInterval = setInterval(() => {
            fetch('/settings/cache/status')
            .then(response => response.json())
            .then(data => {
                if (data.cached) {
                    clearInterval(checkInterval);
                    alertDiv.className = 'alert alert-success mt-3';
                    alertDiv.innerHTML = `
                        <h5><i class="bi bi-check-circle"></i> GitLab Data Refreshed</h5>
                        <p>Successfully loaded ${data.projects} projects and ${data.groups} groups.</p>
                        <div class="mt-2">
                            <a href="/settings" class="btn btn-success">
                                <i class="bi bi-diagram-3"></i> View Group Tree
                            </a>
                            <a href="/settings/projects" class="btn btn-outline-success ms-2">
                                <i class="bi bi-list"></i> View Projects List
                            </a>
                        </div>
                    `;
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error checking cache status:', error);
            });
        }, 5000); // Check every 5 seconds
    }
    
    // Function to check cache status manually
    function checkCacheStatusManual() {
        fetch('/settings/cache/status')
        .then(response => response.json())
        .then(data => {
            const alertDiv = document.querySelector('.alert-info');
            if (!alertDiv) return;
            
            if (data.cached) {
                alertDiv.className = 'alert alert-success';
                alertDiv.innerHTML = `
                    <h5><i class="bi bi-check-circle"></i> GitLab Data Refreshed</h5>
                    <p>Successfully loaded ${data.projects} projects and ${data.groups} groups.</p>
                    <div class="mt-3">
                        <a href="/settings" class="btn btn-success">
                            <i class="bi bi-diagram-3"></i> View Group Tree
                        </a>
                        <a href="/settings/projects" class="btn btn-outline-success ms-2">
                            <i class="bi bi-list"></i> View Projects List
                        </a>
                    </div>
                `;
            } else {
                // Still caching
                alertDiv.innerHTML = `
                    <h5 class="alert-heading"><i class="bi bi-info-circle"></i> Refreshing GitLab Data</h5>
                    <p>Data is still being refreshed. Please wait...</p>
                    <div class="progress mt-2 mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                    </div>
                    <p>Currently loaded: ${data.projects} projects and ${data.groups} groups.</p>
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" onclick="checkCacheStatusManual()">
                            <i class="bi bi-arrow-clockwise"></i> Check Status
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="window.location.reload()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Page
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error checking cache status:', error);
        });
    }
</script>

<script>
    // Project search functionality
    document.getElementById('projectSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        // Check if we're in tree view or list view
        const isTreeView = document.querySelector('.group-tree') !== null;
        
        if (isTreeView) {
            // Tree view search
            const groupItems = document.querySelectorAll('.group-item');
            const allItems = document.querySelectorAll('.list-group-item');
            
            // Filter project items (those with checkboxes)
            const projectItems = Array.from(allItems).filter(item => item.querySelector('input[type="checkbox"]'));
            const groupHeaders = Array.from(allItems).filter(item => !item.querySelector('input[type="checkbox"]'));
            
            // Hide all groups first
            groupItems.forEach(item => {
                item.style.display = 'none';
            });
            
            // Show groups and projects that match the search
            projectItems.forEach(item => {
                const projectName = item.querySelector('strong').textContent.toLowerCase();
                const projectPath = item.querySelector('.text-muted').textContent.toLowerCase();
                
                if (projectName.includes(searchTerm) || projectPath.includes(searchTerm)) {
                    item.style.display = '';
                    
                    // Also show parent group
                    let parent = item.closest('.group-item');
                    while (parent) {
                        parent.style.display = '';
                        parent = parent.parentElement.closest('.group-item');
                    }
                } else {
                    item.style.display = 'none';
                }
            });
            
            // If search is empty, reset to original state
            if (searchTerm === '') {
                groupItems.forEach(item => {
                    item.style.display = '';
                });
            }
        } else {
            // List view search (original code)
            const projectItems = document.querySelectorAll('.list-group-item');
            
            projectItems.forEach(item => {
                const projectName = item.querySelector('strong').textContent.toLowerCase();
                const projectPath = item.querySelector('.text-muted').textContent.toLowerCase();
                
                if (projectName.includes(searchTerm) || projectPath.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
    });
    
    // Select/Deselect All functionality
    document.getElementById('selectAll').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('input[name="projects"]:not(:disabled)');
        checkboxes.forEach(checkbox => {
            if (checkbox.closest('.list-group-item').style.display !== 'none') {
                checkbox.checked = true;
            }
        });
    });
    
    document.getElementById('deselectAll').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('input[name="projects"]:not(:disabled)');
        checkboxes.forEach(checkbox => {
            if (checkbox.closest('.list-group-item').style.display !== 'none') {
                checkbox.checked = false;
            }
        });
    });
</script>
</body>
</html>